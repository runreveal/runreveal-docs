---
title: 'Queries'
description: 'Learn how to write effective SQL queries in RunReveal, including built-in parameters, timestamp fields, optimization techniques, and ClickHouse functions.'
---

import { Callout } from 'nextra/components'

# Queries

<div className="bg-primary-light dark:bg-primary/20 border-l-4 border-primary p-4 my-6 rounded-r-lg">
  <div className="text-sm text-gray-700 dark:text-gray-300 mb-0">
    <strong className="text-primary dark:text-primary">Query System:</strong> RunReveal uses ClickHouse as its query engine, giving you access to powerful SQL capabilities for analyzing your log data. All queries support parameterized syntax for flexible, reusable query patterns.
  </div>
</div>

## Quick Start

Every RunReveal query follows this basic structure with built-in time parameters:

```sql
SELECT *
FROM logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
LIMIT 100
```

**Key Points:**
- Use `` `{from:DateTime}` `` and `` `{to:DateTime}` `` for time filtering (automatically set by the UI)
- Always use `receivedAt` for time-based queries (it's indexed and handles delayed logs)
- Include `LIMIT` to control result size
- Use source-specific views like `aws_cloudtrail_logs` instead of `logs` when possible

## Built-in Parameters

RunReveal automatically provides time-based parameters that are populated based on your time range selection in the UI.

<div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
  <div className="rounded-xl bg-insight-light dark:bg-insight/20 p-4 ring-1 ring-inset ring-insight/30 dark:ring-insight/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Time Parameters</div>
    <div className="text-sm text-gray-600 dark:text-white space-y-2">
      <div><code className="bg-white/50 dark:bg-gray-800 px-1.5 py-0.5 rounded text-xs">&#123;from:DateTime&#125;</code> - Start time (inclusive)</div>
      <div><code className="bg-white/50 dark:bg-gray-800 px-1.5 py-0.5 rounded text-xs">&#123;to:DateTime&#125;</code> - End time (exclusive)</div>
      <div><code className="bg-white/50 dark:bg-gray-800 px-1.5 py-0.5 rounded text-xs">&#123;interval:UInt32&#125;</code> - Time bucket in seconds</div>
      <div><code className="bg-white/50 dark:bg-gray-800 px-1.5 py-0.5 rounded text-xs">&#123;window:UInt32&#125;</code> - Window duration (default: 14400)</div>
    </div>
  </div>

  <div className="rounded-xl bg-primary-light dark:bg-primary/20 p-4 ring-1 ring-inset ring-primary/30 dark:ring-primary/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Custom Parameters</div>
    <div className="text-sm text-gray-600 dark:text-white space-y-2">
      <div>Define your own parameters using <code className="bg-white/50 dark:bg-gray-800 px-1.5 py-0.5 rounded text-xs">&#123;paramName:Type&#125;</code> syntax</div>
      <div className="text-xs text-gray-500 dark:text-gray-400 mt-2">Supported types: String, DateTime, UInt32/64, Int32/64, Float32/64, Array(String), etc.</div>
    </div>
  </div>
</div>

### Example Query with Parameters

```sql
SELECT 
    eventName,
    srcIP,
    COUNT(*) as eventCount
FROM aws_cloudtrail_logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
  AND eventName = 'AssumeRole'
  AND srcIP NOT IN ({officeIPs:Array(String)})
GROUP BY eventName, srcIP
ORDER BY eventCount DESC
LIMIT 100
```

## Timestamp Fields: receivedAt vs eventTime

<Callout type="warning">
<strong>Always use `receivedAt` for time filtering.</strong> It's indexed, handles delayed logs, and ensures consistent query performance across all sources.
</Callout>

<div className="grid grid-cols-1 md:grid-cols-2 gap-6 my-6">
  <div className="rounded-2xl bg-gradient-to-br from-vitality-light to-green-100 dark:from-vitality/20 dark:to-green-800/20 p-6 ring-1 ring-inset ring-vitality/30 dark:ring-vitality/50">
    <div className="text-lg font-black text-gray-900 dark:text-white mb-3 flex items-center">
      <span className="mr-2">✓</span> receivedAt (Recommended)
    </div>
    <div className="text-sm text-gray-600 dark:text-white space-y-2 mb-4">
      <div><strong>When RunReveal received the event</strong></div>
      <div>• Indexed (part of primary key) - fast queries</div>
      <div>• Consistent across all sources</div>
      <div>• Handles delayed log delivery</div>
      <div>• Optimized for partitioning</div>
    </div>
    <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mt-4">Use for: Time filtering, detections, scheduled queries</div>
  </div>

  <div className="rounded-2xl bg-gradient-to-br from-slate-100 to-gray-200 dark:from-slate-800/20 dark:to-gray-700/20 p-6 ring-1 ring-inset ring-slate-300/30 dark:ring-slate-600/50">
    <div className="text-lg font-black text-gray-900 dark:text-white mb-3 flex items-center">
      <span className="mr-2">⚠</span> eventTime
    </div>
    <div className="text-sm text-gray-600 dark:text-white space-y-2 mb-4">
      <div><strong>When the event occurred (from source)</strong></div>
      <div>• Not indexed - slower queries</div>
      <div>• May be inconsistent across sources</div>
      <div>• Can be missing for some sources</div>
      <div>• Doesn't account for delivery delays</div>
    </div>
    <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 mt-4">Use for: Displaying original event time, source timestamp analysis</div>
  </div>
</div>

### Best Practice Example

```sql
-- ✅ Good: Uses indexed receivedAt
SELECT *
FROM logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
  AND eventName = 'Login'

-- ❌ Avoid: Uses unindexed eventTime
SELECT *
FROM logs
WHERE eventTime >= {from:DateTime}
  AND eventTime < {to:DateTime}
  AND eventName = 'Login'
```

## Query Optimization

Follow these best practices to write fast, efficient queries:

<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 my-6">
  <div className="rounded-xl bg-primary-light dark:bg-primary/20 p-5 ring-1 ring-inset ring-primary/30 dark:ring-primary/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Use Source-Specific Views</div>
    <div className="text-sm text-gray-600 dark:text-white mb-3">
      Query optimized views like <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">aws_cloudtrail_logs</code> instead of the generic <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">logs</code> table.
    </div>
    <div className="text-xs text-gray-500 dark:text-gray-400">Available: aws_cloudtrail_logs, okta_logs, github_logs, aws_vpc_flow_logs, and more</div>
  </div>

  <div className="rounded-xl bg-insight-light dark:bg-insight/20 p-5 ring-1 ring-inset ring-insight/30 dark:ring-insight/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Filter Early</div>
    <div className="text-sm text-gray-600 dark:text-white">
      Apply filters on indexed fields (receivedAt, sourceType, sourceID) first to reduce dataset size before processing.
    </div>
  </div>

  <div className="rounded-xl bg-vitality-light dark:bg-vitality/20 p-5 ring-1 ring-inset ring-vitality/30 dark:ring-vitality/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Use Smaller Time Ranges</div>
    <div className="text-sm text-gray-600 dark:text-white">
      Start with 1 hour to test, then expand. Shorter windows process much faster than 30-day ranges.
    </div>
  </div>

  <div className="rounded-xl bg-accent-light dark:bg-accent/20 p-5 ring-1 ring-inset ring-accent/30 dark:ring-accent/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Always Use LIMIT</div>
    <div className="text-sm text-gray-600 dark:text-white">
      Prevent processing excessive data by including <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">LIMIT</code> in every query.
    </div>
  </div>

  <div className="rounded-xl bg-secondary-light dark:bg-secondary/20 p-5 ring-1 ring-inset ring-secondary/30 dark:ring-secondary/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Use Aggregations</div>
    <div className="text-sm text-gray-600 dark:text-white">
      Prefer <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">COUNT</code>, <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">GROUP BY</code> over returning all individual events.
    </div>
  </div>

  <div className="rounded-xl bg-slate-100 dark:bg-slate-800/20 p-5 ring-1 ring-inset ring-slate-300/30 dark:ring-slate-600/50">
    <div className="font-black text-gray-900 dark:text-white mb-2">Filter by sourceType</div>
    <div className="text-sm text-gray-600 dark:text-white">
      When querying the <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">logs</code> table, always include <code className="bg-white/50 dark:bg-gray-800 px-1 py-0.5 rounded text-xs">sourceType</code> filter.
    </div>
  </div>
</div>

## Common Query Patterns

<details>
<summary className="cursor-pointer text-lg font-semibold text-gray-900 dark:text-white mb-4">View Common Query Patterns</summary>

<div className="space-y-6 mt-4">
  <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
    <div className="font-semibold text-gray-900 dark:text-white mb-2">Basic Time-Range Query</div>
    <pre className="text-xs"><code>{`SELECT *
FROM logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
LIMIT 100`}</code></pre>
  </div>

  <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
    <div className="font-semibold text-gray-900 dark:text-white mb-2">Filtered Search</div>
    <pre className="text-xs"><code>{`SELECT eventName, srcIP, eventTime
FROM aws_cloudtrail_logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
  AND eventName = 'AssumeRole'
  AND srcIP != ''
ORDER BY eventTime DESC
LIMIT 100`}</code></pre>
  </div>

  <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
    <div className="font-semibold text-gray-900 dark:text-white mb-2">Aggregation with Grouping</div>
    <pre className="text-xs"><code>{`SELECT 
    eventName,
    srcIP,
    COUNT(*) as eventCount,
    min(eventTime) as firstSeen,
    max(eventTime) as lastSeen
FROM aws_cloudtrail_logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
GROUP BY eventName, srcIP
HAVING eventCount > 10
ORDER BY eventCount DESC
LIMIT 100`}</code></pre>
  </div>

  <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
    <div className="font-semibold text-gray-900 dark:text-white mb-2">Time-Series Aggregation</div>
    <pre className="text-xs"><code>{`SELECT 
    toStartOfHour(receivedAt) as hour,
    eventName,
    COUNT(*) as count
FROM aws_cloudtrail_logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
GROUP BY hour, eventName
ORDER BY hour DESC, count DESC`}</code></pre>
  </div>

  <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
    <div className="font-semibold text-gray-900 dark:text-white mb-2">Top N Analysis</div>
    <pre className="text-xs"><code>{`SELECT 
    srcIP,
    COUNT(*) as eventCount,
    count(DISTINCT eventName) as uniqueEvents
FROM logs
WHERE receivedAt >= {from:DateTime}
  AND receivedAt < {to:DateTime}
  AND sourceType = 'aws_cloudtrail'
GROUP BY srcIP
ORDER BY eventCount DESC
LIMIT 10`}</code></pre>
  </div>
</div>
</details>

## ClickHouse Functions Reference

<details>
<summary className="cursor-pointer text-lg font-semibold text-gray-900 dark:text-white mb-4">View ClickHouse Functions</summary>

<div className="mt-4">
  <div className="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
    <div className="text-sm text-gray-700 dark:text-gray-300">
      <strong>Complete Reference:</strong> RunReveal uses ClickHouse as its query engine. For a complete list of all available functions, see the <a href="https://clickhouse.com/docs/en/sql-reference/functions/" className="text-primary dark:text-primary underline">ClickHouse Functions Documentation</a>.
    </div>
  </div>

  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div className="rounded-xl bg-gray-50 dark:bg-gray-900/50 p-4 border border-gray-200 dark:border-gray-700">
      <div className="font-semibold text-gray-900 dark:text-white mb-2">Date & Time</div>
      <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
        <div><code>toYear()</code>, <code>toMonth()</code>, <code>toHour()</code></div>
        <div><code>toStartOfHour()</code>, <code>toStartOfDay()</code></div>
        <div><code>dateDiff()</code>, <code>formatDateTime()</code></div>
      </div>
    </div>

    <div className="rounded-xl bg-gray-50 dark:bg-gray-900/50 p-4 border border-gray-200 dark:border-gray-700">
      <div className="font-semibold text-gray-900 dark:text-white mb-2">String Functions</div>
      <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
        <div><code>match()</code>, <code>LIKE</code>, <code>extract()</code></div>
        <div><code>splitByChar()</code>, <code>upper()</code>, <code>lower()</code></div>
        <div><code>trim()</code>, <code>replace()</code></div>
      </div>
    </div>

    <div className="rounded-xl bg-gray-50 dark:bg-gray-900/50 p-4 border border-gray-200 dark:border-gray-700">
      <div className="font-semibold text-gray-900 dark:text-white mb-2">Array Functions</div>
      <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
        <div><code>arrayJoin()</code>, <code>length()</code>, <code>has()</code></div>
        <div><code>hasAny()</code></div>
      </div>
    </div>

    <div className="rounded-xl bg-gray-50 dark:bg-gray-900/50 p-4 border border-gray-200 dark:border-gray-700">
      <div className="font-semibold text-gray-900 dark:text-white mb-2">Map Functions</div>
      <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
        <div><code>map['key']</code> - Access map values</div>
        <div><code>mapKeys()</code>, <code>mapValues()</code></div>
        <div><code>has(map, 'key')</code></div>
      </div>
    </div>

    <div className="rounded-xl bg-gray-50 dark:bg-gray-900/50 p-4 border border-gray-200 dark:border-gray-700">
      <div className="font-semibold text-gray-900 dark:text-white mb-2">Aggregations</div>
      <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
        <div><code>COUNT()</code>, <code>sum()</code>, <code>avg()</code></div>
        <div><code>quantile()</code>, <code>groupArray()</code></div>
        <div><code>min()</code>, <code>max()</code></div>
      </div>
    </div>

    <div className="rounded-xl bg-gray-50 dark:bg-gray-900/50 p-4 border border-gray-200 dark:border-gray-700">
      <div className="font-semibold text-gray-900 dark:text-white mb-2">Conditionals & JSON</div>
      <div className="text-xs text-gray-600 dark:text-gray-400 space-y-1">
        <div><code>if()</code>, <code>multiIf()</code>, <code>coalesce()</code></div>
        <div><code>JSONExtractString()</code>, <code>JSONHas()</code></div>
      </div>
    </div>
  </div>
</div>
</details>

## Common Mistakes to Avoid

<div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
  <div className="rounded-xl bg-red-50 dark:bg-red-900/20 p-4 border border-red-200 dark:border-red-800">
    <div className="font-semibold text-red-900 dark:text-red-200 mb-2 flex items-center">
      <span className="mr-2">❌</span> Common Mistakes
    </div>
    <div className="text-sm text-red-700 dark:text-red-300 space-y-2">
      <div>• Using <code className="bg-red-100 dark:bg-red-900/30 px-1 rounded">eventTime</code> for time filtering</div>
      <div>• Missing time range filters</div>
      <div>• No <code className="bg-red-100 dark:bg-red-900/30 px-1 rounded">LIMIT</code> clause</div>
      <div>• Querying <code className="bg-red-100 dark:bg-red-900/30 px-1 rounded">logs</code> without <code className="bg-red-100 dark:bg-red-900/30 px-1 rounded">sourceType</code> filter</div>
      <div>• Using <code className="bg-red-100 dark:bg-red-900/30 px-1 rounded">SELECT *</code> with <code className="bg-red-100 dark:bg-red-900/30 px-1 rounded">GROUP BY</code></div>
    </div>
  </div>

  <div className="rounded-xl bg-green-50 dark:bg-green-900/20 p-4 border border-green-200 dark:border-green-800">
    <div className="font-semibold text-green-900 dark:text-green-200 mb-2 flex items-center">
      <span className="mr-2">✅</span> Best Practices
    </div>
    <div className="text-sm text-green-700 dark:text-green-300 space-y-2">
      <div>• Always use <code className="bg-green-100 dark:bg-green-900/30 px-1 rounded">receivedAt</code> for time filtering</div>
      <div>• Include time range filters in every query</div>
      <div>• Always include <code className="bg-green-100 dark:bg-green-900/30 px-1 rounded">LIMIT</code></div>
      <div>• Filter by <code className="bg-green-100 dark:bg-green-900/30 px-1 rounded">sourceType</code> when using <code className="bg-green-100 dark:bg-green-900/30 px-1 rounded">logs</code> table</div>
      <div>• Select only needed columns in aggregations</div>
    </div>
  </div>
</div>

### Quick Performance Tips

- **Start Small**: Test with 1-hour windows before expanding
- **Use EXPLAIN**: Check execution plans when optimizing
- **Monitor Query Time**: Watch execution times in the UI
- **Index Usage**: Filter on indexed columns (receivedAt, sourceType, sourceID)
- **Avoid Full Scans**: Always include time range filters
- **Limit Aggregations**: Use LIMIT even with GROUP BY

## Related Documentation

- **[Explore Logs](/logs/search)** - Learn how to use the query interface
- **[Writing Detections](/detections/writing-detections)** - Create detection rules from queries
- **[ClickHouse Documentation](https://clickhouse.com/docs/)** - Complete ClickHouse reference
- **[ClickHouse Functions](https://clickhouse.com/docs/en/sql-reference/functions/)** - All available functions
